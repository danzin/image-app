services:
  # --- DATABASE & CACHE INFRASTRUCTURE ---
  mongo-setup:
    image: mongo:8
    container_name: mongo-setup
    command: >
      bash -c "
        echo 'Creating keyfile for MongoDB replica set...' &&
        openssl rand -base64 756 > /tmp/mongodb-keyfile &&
        chmod 400 /tmp/mongodb-keyfile &&
        cp /tmp/mongodb-keyfile /data/mongodb-keyfile &&
        chown 999:999 /data/mongodb-keyfile &&
        echo 'Keyfile created successfully!'
      "
    volumes:
      - mongo_keyfile:/data
    networks:
      - app-network

  mongo:
    image: mongo:8
    container_name: mongo
    restart: always
    ports:
      - "27017:27017"
    networks:
      - app-network
    volumes:
      - mongo_data:/data/db
      - mongo_keyfile:/opt/keyfile:ro
    environment:
      MONGO_INITDB_ROOT_USERNAME: root
      MONGO_INITDB_ROOT_PASSWORD: secret
    command: ["mongod", "--replSet", "rs0", "--keyFile", "/opt/keyfile/mongodb-keyfile", "--bind_ip_all"]
    depends_on:
      - mongo-setup
    healthcheck:
      test: >
        mongosh --host mongo -u root -p secret --authenticationDatabase admin --quiet --eval "
          try {
            const st = rs.status();
            if ([1,2,7].includes(st.myState)) { quit(0); } else { quit(1); }
          } catch (e) { quit(1); }
        "
      interval: 10s
      timeout: 5s
      retries: 15
      start_period: 90s

  mongo-rs-init:
    image: mongo:8
    container_name: mongo-rs-init
    depends_on:
      - mongo
    networks:
      - app-network
    environment:
      MONGO_INITDB_ROOT_USERNAME: root
      MONGO_INITDB_ROOT_PASSWORD: secret
      MONGO_HOST: mongo
    volumes:
      - ./mongo-rs-init.sh:/rs-init/mongo-rs-init.sh:ro
    entrypoint: ["bash", "/rs-init/mongo-rs-init.sh"]
    restart: "no"

  redis-service:
    image: redis:alpine
    container_name: redis-service
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - app-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  # --- APPLICATION SERVICES ---
  backend:
    build:
      context: .
      dockerfile: backend/backend.Dockerfile
    container_name: backend
    restart: always
    ports:
      - "3000:3000"
    # shared environment variables here using a YAML anchor (&)
    environment: &backend-environment
      NODE_ENV: production
      MONGODB_URI: mongodb://root:secret@mongo:27017/PhotoAppOOP?authSource=admin&replicaSet=rs0
      REDIS_URL: redis://redis-service:6379
      JWT_SECRET: YourProductionJWTSecretGoesHere
      ALLOWED_ORIGINS: http://localhost,http://localhost:80,http://localhost:5173,http://localhost:8000,http://192.168.1.10:80
      COOKIE_SECURE: "false" # true in real production environment with HTTPS
      # Cloudinary credentials go here for production
      # CLOUDINARY_CLOUD_NAME: ...
      # CLOUDINARY_API_KEY: ...
      # CLOUDINARY_API_SECRET: ...
    depends_on:
      mongo:
        condition: service_healthy
      mongo-rs-init:
        condition: service_completed_successfully
      redis-service:
        condition: service_healthy
    networks:
      - app-network
    volumes:
      - ./backend/uploads:/app/backend/uploads
    healthcheck:
      test: ["CMD", "sh", "-c", "wget --no-verbose --tries=1 --spider http://localhost:3000/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s

  api-gateway:
    build:
      context: .
      dockerfile: api-gateway/gateway.Dockerfile
    container_name: api-gateway
    restart: always
    ports:
      - "8000:8000"
    environment:
      NODE_ENV: production
      PORT: 8000
      BACKEND_MONOLITH_URL: http://backend:3000
    depends_on:
      backend:
        condition: service_healthy
    networks:
      - app-network
    healthcheck:
      test: ["CMD", "sh", "-c", "wget --no-verbose --tries=1 --spider http://localhost:8000/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s

  frontend:
    build:
      context: .
      dockerfile: frontend/frontend.Dockerfile
      args:
        VITE_API_URL: /
        VITE_SOCKET_URL: /
    container_name: frontend
    restart: always
    ports:
      - "80:80"
    depends_on:
      api-gateway:
        condition: service_healthy
    networks:
      - app-network

  prometheus:
    image: prom/prometheus:v3.0.0
    container_name: prometheus
    restart: unless-stopped
    ports:
      - "9090:9090"
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.retention.time=3d"
      - "--storage.tsdb.path=/prometheus"
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
    depends_on:
      backend:
        condition: service_healthy
      api-gateway:
        condition: service_healthy
    networks:
      - app-network
    mem_limit: 256m
    cpu_shares: 256

  grafana:
    image: grafana/grafana:11.1.0
    container_name: grafana
    restart: unless-stopped
    ports:
      - "3001:3000"
    environment:
      GF_SECURITY_ADMIN_PASSWORD: admin
      GF_SECURITY_ADMIN_USER: admin
    depends_on:
      prometheus:
        condition: service_started
    networks:
      - app-network
    mem_limit: 256m
    cpu_shares: 256

  # Workers now in-process with the backend on the same Node event loop
  # ENABLE_WORKERS=false in backend environment to disable them

networks:
  app-network:
    driver: bridge

volumes:
  redis_data:
  mongo_data:
  mongo_keyfile:
